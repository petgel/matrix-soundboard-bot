{"version":3,"file":"pushprocessor.js","names":["deepCompare","escapeRegExp","globToRegexp","isNullOrUndefined","logger","ConditionKind","PushRuleActionName","PushRuleKind","RuleId","TweakName","EventType","RULEKINDS_IN_ORDER","Override","ContentSpecific","RoomSpecific","SenderSpecific","Underride","DEFAULT_OVERRIDE_RULES","rule_id","default","enabled","conditions","kind","EventPropertyIs","key","value","SenderNotificationPermission","actions","Notify","set_tweak","Highlight","EventMatch","pattern","DontNotify","RoomServerAcl","UserDefinedRules","Symbol","EXPECTED_DEFAULT_OVERRIDE_RULE_IDS","Master","SuppressNotices","InviteToSelf","MemberEvent","IsUserMention","ContainsDisplayName","IsRoomMention","AtRoomNotification","Tombstone","DEFAULT_UNDERRIDE_RULES","CallStarted","Sound","EXPECTED_DEFAULT_UNDERRIDE_RULE_IDS","IncomingCall","EncryptedDM","DM","Message","EncryptedMessage","mergeRulesWithDefaults","incomingRules","defaultRules","orderedRuleIds","incomingDefaultRules","filter","rule","incomingCustomRules","insertDefaultPushRule","ruleId","newRules","push","warn","concat","nextExpectedRuleIdIndex","ruleIndex","indexOf","defaultRuleId","slice","PushProcessor","constructor","client","_defineProperty","Map","actionListToActionsObject","actionList","actionObj","notify","tweaks","action","undefined","rewriteDefaultRules","userId","arguments","length","JSON","parse","stringify","global","override","underride","updateCachedPushRuleKeys","room","sender","toRemoveKeys","Set","parsedKeys","keys","ruleset","condition","delete","set","partsForDottedKey","forEach","k","matchingRuleFromKindSet","ev","kindset","rawrule","templateRuleToRaw","ruleMatchesEvent","_objectSpread","tprule","eventFulfillsCondition","cond","eventFulfillsEventMatchCondition","eventFulfillsEventPropertyIsCondition","EventPropertyContains","eventFulfillsEventPropertyContains","eventFulfillsDisplayNameCondition","RoomMemberCount","eventFulfillsRoomMemberCountCondition","eventFulfillsSenderNotifPermCondition","CallStartedPrefix","eventFulfillsCallStartedCondition","notifLevelKey","getRoom","getRoomId","currentState","mayTriggerNotifOfType","getSender","is","members","memberCount","getJoinedMemberCount","m","match","ineq","rhs","parseInt","isNaN","_room$currentState","content","getContent","isEncrypted","getClearContent","body","member","getMember","credentials","displayName","name","pat","RegExp","search","val","valueForDottedKey","regex","createCachedRegex","Array","isArray","includes","_cond","getPrevContent","prefix","glob","suffix","cachedGlobToRegex","str","result","part","escaped","c","parts","get","firstPart","currentIndex","getType","event","thisPart","matchingRuleForEventWithRulesets","rulesets","getSafeUserId","pushActionsForEventAndRulesets","highlight","_rule$conditions","supportsIntentionalMentions","ContainsUserName","some","actionsForEvent","pushRules","actionsAndRuleForEvent","getPushRuleById","_result$rule","getPushRuleAndKindById","scope","_this$client$pushRule"],"sources":["../src/pushprocessor.ts"],"sourcesContent":["/*\nCopyright 2015 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { deepCompare, escapeRegExp, globToRegexp, isNullOrUndefined } from \"./utils.ts\";\nimport { logger } from \"./logger.ts\";\nimport { type MatrixClient } from \"./client.ts\";\nimport { type MatrixEvent } from \"./models/event.ts\";\nimport {\n    ConditionKind,\n    type IAnnotatedPushRule,\n    type ICallStartedCondition,\n    type ICallStartedPrefixCondition,\n    type IContainsDisplayNameCondition,\n    type IEventMatchCondition,\n    type IEventPropertyContainsCondition,\n    type IEventPropertyIsCondition,\n    type IPushRule,\n    type IPushRules,\n    type IRoomMemberCountCondition,\n    type ISenderNotificationPermissionCondition,\n    type PushRuleAction,\n    PushRuleActionName,\n    type PushRuleCondition,\n    PushRuleKind,\n    type PushRuleSet,\n    RuleId,\n    TweakName,\n} from \"./@types/PushRules.ts\";\nimport { EventType } from \"./@types/event.ts\";\n\nconst RULEKINDS_IN_ORDER = [\n    PushRuleKind.Override,\n    PushRuleKind.ContentSpecific,\n    PushRuleKind.RoomSpecific,\n    PushRuleKind.SenderSpecific,\n    PushRuleKind.Underride,\n];\n\n// The default override rules to apply to the push rules that arrive from the server.\n// We do this for two reasons:\n//   1. Synapse is unlikely to send us the push rule in an incremental sync - see\n//      https://github.com/matrix-org/synapse/pull/4867#issuecomment-481446072 for\n//      more details.\n//   2. We often want to start using push rules ahead of the server supporting them,\n//      and so we can put them here.\nconst DEFAULT_OVERRIDE_RULES: Record<string, IPushRule> = {\n    \".m.rule.is_room_mention\": {\n        // Matrix v1.7\n        rule_id: \".m.rule.is_room_mention\",\n        default: true,\n        enabled: true,\n        conditions: [\n            {\n                kind: ConditionKind.EventPropertyIs,\n                key: \"content.m\\\\.mentions.room\",\n                value: true,\n            },\n            {\n                kind: ConditionKind.SenderNotificationPermission,\n                key: \"room\",\n            },\n        ],\n        actions: [\n            PushRuleActionName.Notify,\n            {\n                set_tweak: TweakName.Highlight,\n            },\n        ],\n    },\n    \".m.rule.reaction\": {\n        // For homeservers which don't support MSC2153 yet\n        rule_id: \".m.rule.reaction\",\n        default: true,\n        enabled: true,\n        conditions: [\n            {\n                kind: ConditionKind.EventMatch,\n                key: \"type\",\n                pattern: \"m.reaction\",\n            },\n        ],\n        actions: [PushRuleActionName.DontNotify],\n    },\n    \".org.matrix.msc3786.rule.room.server_acl\": {\n        // For homeservers which don't support MSC3786 yet\n        rule_id: \".org.matrix.msc3786.rule.room.server_acl\",\n        default: true,\n        enabled: true,\n        conditions: [\n            {\n                kind: ConditionKind.EventMatch,\n                key: \"type\",\n                pattern: EventType.RoomServerAcl,\n            },\n            {\n                kind: ConditionKind.EventMatch,\n                key: \"state_key\",\n                pattern: \"\",\n            },\n        ],\n        actions: [],\n    },\n};\n\n// A special rule id for `EXPECTED_DEFAULT_OVERRIDE_RULE_IDS` and friends which denotes where user-defined rules live in the order.\nconst UserDefinedRules = Symbol(\"UserDefinedRules\");\n\ntype OrderedRules = Array<string | typeof UserDefinedRules>;\n\nconst EXPECTED_DEFAULT_OVERRIDE_RULE_IDS: OrderedRules = [\n    RuleId.Master,\n    UserDefinedRules,\n    RuleId.SuppressNotices,\n    RuleId.InviteToSelf,\n    RuleId.MemberEvent,\n    RuleId.IsUserMention,\n    RuleId.ContainsDisplayName,\n    RuleId.IsRoomMention,\n    RuleId.AtRoomNotification,\n    RuleId.Tombstone,\n    \".m.rule.reaction\",\n    \".m.rule.room.server_acl\",\n    \".org.matrix.msc3786.rule.room.server_acl\",\n    \".m.rule.suppress_edits\",\n];\n\nconst DEFAULT_UNDERRIDE_RULES: Record<string, IPushRule> = {\n    \".org.matrix.msc3914.rule.room.call\": {\n        // For homeservers which don't support MSC3914 yet\n        rule_id: \".org.matrix.msc3914.rule.room.call\",\n        default: true,\n        enabled: true,\n        conditions: [\n            {\n                kind: ConditionKind.EventMatch,\n                key: \"type\",\n                pattern: \"org.matrix.msc3401.call\",\n            },\n            {\n                kind: ConditionKind.CallStarted,\n            },\n        ],\n        actions: [PushRuleActionName.Notify, { set_tweak: TweakName.Sound, value: \"default\" }],\n    },\n};\n\nconst EXPECTED_DEFAULT_UNDERRIDE_RULE_IDS: OrderedRules = [\n    UserDefinedRules,\n    RuleId.IncomingCall,\n    \".org.matrix.msc3914.rule.room.call\",\n    RuleId.EncryptedDM,\n    RuleId.DM,\n    RuleId.Message,\n    RuleId.EncryptedMessage,\n];\n\n/**\n * Make sure that each of the rules listed in `defaultRuleIds` is listed in the given set of push rules.\n *\n * @param kind - the kind of push rule set being merged.\n * @param incomingRules - the existing set of known push rules for the user.\n * @param defaultRules - a lookup table for the default definitions of push rules.\n * @param orderedRuleIds - the IDs of the expected push rules, in order.\n *\n * @returns A copy of `incomingRules`, with any missing default rules inserted in the right place.\n */\nfunction mergeRulesWithDefaults(\n    kind: PushRuleKind,\n    incomingRules: IPushRule[],\n    defaultRules: Record<string, IPushRule>,\n    orderedRuleIds: OrderedRules,\n): IPushRule[] {\n    // Split the incomingRules into defaults and custom\n    const incomingDefaultRules = incomingRules.filter((rule) => rule.default);\n    const incomingCustomRules = incomingRules.filter((rule) => !rule.default);\n\n    function insertDefaultPushRule(ruleId: OrderedRules[number]): void {\n        if (ruleId === UserDefinedRules) {\n            // Re-insert any user-defined rules that were in `incomingRules`\n            newRules.push(...incomingCustomRules);\n        } else if (ruleId in defaultRules) {\n            logger.warn(`Adding default global ${kind} push rule ${ruleId}`);\n            newRules.push(defaultRules[ruleId]);\n        } else {\n            logger.warn(`Missing default global ${kind} push rule ${ruleId}`);\n        }\n    }\n\n    let nextExpectedRuleIdIndex = 0;\n    const newRules: IPushRule[] = [];\n    // Merge our expected rules (including the incoming custom rules) into the incoming default rules.\n    for (const rule of incomingDefaultRules) {\n        const ruleIndex = orderedRuleIds.indexOf(rule.rule_id);\n        if (ruleIndex === -1) {\n            // an unrecognised rule; copy it over\n            newRules.push(rule);\n            continue;\n        }\n        while (ruleIndex > nextExpectedRuleIdIndex) {\n            // insert new rules\n            const defaultRuleId = orderedRuleIds[nextExpectedRuleIdIndex];\n            insertDefaultPushRule(defaultRuleId);\n            nextExpectedRuleIdIndex += 1;\n        }\n        // copy over the existing rule\n        newRules.push(rule);\n        nextExpectedRuleIdIndex += 1;\n    }\n\n    // Now copy over any remaining default rules\n    for (const ruleId of orderedRuleIds.slice(nextExpectedRuleIdIndex)) {\n        insertDefaultPushRule(ruleId);\n    }\n\n    return newRules;\n}\n\nexport interface IActionsObject {\n    /** Whether this event should notify the user or not. */\n    notify: boolean;\n    /** How this event should be notified. */\n    tweaks: Partial<Record<TweakName, any>>;\n}\n\nexport class PushProcessor {\n    /**\n     * Construct a Push Processor.\n     * @param client - The Matrix client object to use\n     */\n    public constructor(private readonly client: MatrixClient) {}\n\n    /**\n     * Maps the original key from the push rules to a list of property names\n     * after unescaping.\n     */\n    private readonly parsedKeys = new Map<string, string[]>();\n\n    /**\n     * Convert a list of actions into a object with the actions as keys and their values\n     * @example\n     * eg. `[ 'notify', { set_tweak: 'sound', value: 'default' } ]`\n     *     becomes `{ notify: true, tweaks: { sound: 'default' } }`\n     * @param actionList - The actions list\n     *\n     * @returns A object with key 'notify' (true or false) and an object of actions\n     */\n    public static actionListToActionsObject(actionList: PushRuleAction[]): IActionsObject {\n        const actionObj: IActionsObject = { notify: false, tweaks: {} };\n        for (const action of actionList) {\n            if (action === PushRuleActionName.Notify) {\n                actionObj.notify = true;\n            } else if (typeof action === \"object\") {\n                if (action.value === undefined) {\n                    action.value = true;\n                }\n                actionObj.tweaks[action.set_tweak] = action.value;\n            }\n        }\n        return actionObj;\n    }\n\n    /**\n     * Rewrites conditions on a client's push rules to match the defaults\n     * where applicable. Useful for upgrading push rules to more strict\n     * conditions when the server is falling behind on defaults.\n     * @param incomingRules - The client's existing push rules\n     * @param userId - The Matrix ID of the client.\n     * @returns The rewritten rules\n     */\n    public static rewriteDefaultRules(incomingRules: IPushRules, userId: string | undefined = undefined): IPushRules {\n        let newRules: IPushRules = JSON.parse(JSON.stringify(incomingRules)); // deep clone\n\n        // These lines are mostly to make the tests happy. We shouldn't run into these\n        // properties missing in practice.\n        if (!newRules) newRules = {} as IPushRules;\n        if (!newRules.global) newRules.global = {} as PushRuleSet;\n        if (!newRules.global.override) newRules.global.override = [];\n        if (!newRules.global.underride) newRules.global.underride = [];\n\n        // Merge the client-level defaults with the ones from the server\n        newRules.global.override = mergeRulesWithDefaults(\n            PushRuleKind.Override,\n            newRules.global.override,\n            DEFAULT_OVERRIDE_RULES,\n            EXPECTED_DEFAULT_OVERRIDE_RULE_IDS,\n        );\n\n        newRules.global.underride = mergeRulesWithDefaults(\n            PushRuleKind.Underride,\n            newRules.global.underride,\n            DEFAULT_UNDERRIDE_RULES,\n            EXPECTED_DEFAULT_UNDERRIDE_RULE_IDS,\n        );\n\n        return newRules;\n    }\n\n    /**\n     * Pre-caches the parsed keys for push rules and cleans out any obsolete cache\n     * entries. Should be called after push rules are updated.\n     * @param newRules - The new push rules.\n     */\n    public updateCachedPushRuleKeys(newRules: IPushRules): void {\n        // These lines are mostly to make the tests happy. We shouldn't run into these\n        // properties missing in practice.\n        if (!newRules) newRules = {} as IPushRules;\n        if (!newRules.global) newRules.global = {} as PushRuleSet;\n        if (!newRules.global.override) newRules.global.override = [];\n        if (!newRules.global.room) newRules.global.room = [];\n        if (!newRules.global.sender) newRules.global.sender = [];\n        if (!newRules.global.underride) newRules.global.underride = [];\n\n        // Process the 'key' property on event_match conditions pre-cache the\n        // values and clean-out any unused values.\n        const toRemoveKeys = new Set(this.parsedKeys.keys());\n        for (const ruleset of [\n            newRules.global.override,\n            newRules.global.room,\n            newRules.global.sender,\n            newRules.global.underride,\n        ]) {\n            for (const rule of ruleset) {\n                if (!rule.conditions) {\n                    continue;\n                }\n\n                for (const condition of rule.conditions) {\n                    if (condition.kind !== ConditionKind.EventMatch) {\n                        continue;\n                    }\n\n                    // Ensure we keep this key.\n                    toRemoveKeys.delete(condition.key);\n\n                    // Pre-process the key.\n                    this.parsedKeys.set(condition.key, PushProcessor.partsForDottedKey(condition.key));\n                }\n            }\n        }\n        // Any keys that were previously cached, but are no longer needed should\n        // be removed.\n        toRemoveKeys.forEach((k) => this.parsedKeys.delete(k));\n    }\n\n    private static cachedGlobToRegex: Record<string, RegExp> = {}; // $glob: RegExp\n\n    private matchingRuleFromKindSet(ev: MatrixEvent, kindset: PushRuleSet): IAnnotatedPushRule | null {\n        for (const kind of RULEKINDS_IN_ORDER) {\n            const ruleset = kindset[kind];\n            if (!ruleset) {\n                continue;\n            }\n\n            for (const rule of ruleset) {\n                if (!rule.enabled) {\n                    continue;\n                }\n\n                const rawrule = this.templateRuleToRaw(kind, rule);\n                if (!rawrule) {\n                    continue;\n                }\n\n                if (this.ruleMatchesEvent(rawrule, ev)) {\n                    return {\n                        ...rule,\n                        kind,\n                    };\n                }\n            }\n        }\n        return null;\n    }\n\n    private templateRuleToRaw(\n        kind: PushRuleKind,\n        tprule: IPushRule,\n    ): Pick<IPushRule, \"rule_id\" | \"actions\" | \"conditions\"> | null {\n        const rawrule: Pick<IPushRule, \"rule_id\" | \"actions\" | \"conditions\"> = {\n            rule_id: tprule.rule_id,\n            actions: tprule.actions,\n            conditions: [],\n        };\n        switch (kind) {\n            case PushRuleKind.Underride:\n            case PushRuleKind.Override:\n                rawrule.conditions = tprule.conditions;\n                break;\n            case PushRuleKind.RoomSpecific:\n                if (!tprule.rule_id) {\n                    return null;\n                }\n                rawrule.conditions!.push({\n                    kind: ConditionKind.EventMatch,\n                    key: \"room_id\",\n                    value: tprule.rule_id,\n                });\n                break;\n            case PushRuleKind.SenderSpecific:\n                if (!tprule.rule_id) {\n                    return null;\n                }\n                rawrule.conditions!.push({\n                    kind: ConditionKind.EventMatch,\n                    key: \"user_id\",\n                    value: tprule.rule_id,\n                });\n                break;\n            case PushRuleKind.ContentSpecific:\n                if (!tprule.pattern) {\n                    return null;\n                }\n                rawrule.conditions!.push({\n                    kind: ConditionKind.EventMatch,\n                    key: \"content.body\",\n                    pattern: tprule.pattern,\n                });\n                break;\n        }\n        return rawrule;\n    }\n\n    private eventFulfillsCondition(cond: PushRuleCondition, ev: MatrixEvent): boolean {\n        switch (cond.kind) {\n            case ConditionKind.EventMatch:\n                return this.eventFulfillsEventMatchCondition(cond, ev);\n            case ConditionKind.EventPropertyIs:\n                return this.eventFulfillsEventPropertyIsCondition(cond, ev);\n            case ConditionKind.EventPropertyContains:\n                return this.eventFulfillsEventPropertyContains(cond, ev);\n            case ConditionKind.ContainsDisplayName:\n                return this.eventFulfillsDisplayNameCondition(cond, ev);\n            case ConditionKind.RoomMemberCount:\n                return this.eventFulfillsRoomMemberCountCondition(cond, ev);\n            case ConditionKind.SenderNotificationPermission:\n                return this.eventFulfillsSenderNotifPermCondition(cond, ev);\n            case ConditionKind.CallStarted:\n            case ConditionKind.CallStartedPrefix:\n                return this.eventFulfillsCallStartedCondition(cond, ev);\n        }\n\n        // unknown conditions: we previously matched all unknown conditions,\n        // but given that rules can be added to the base rules on a server,\n        // it's probably better to not match unknown conditions.\n        return false;\n    }\n\n    private eventFulfillsSenderNotifPermCondition(\n        cond: ISenderNotificationPermissionCondition,\n        ev: MatrixEvent,\n    ): boolean {\n        const notifLevelKey = cond[\"key\"];\n        if (!notifLevelKey) {\n            return false;\n        }\n\n        const room = this.client.getRoom(ev.getRoomId());\n        if (!room?.currentState) {\n            return false;\n        }\n\n        // Note that this should not be the current state of the room but the state at\n        // the point the event is in the DAG. Unfortunately the js-sdk does not store\n        // this.\n        return room.currentState.mayTriggerNotifOfType(notifLevelKey, ev.getSender()!);\n    }\n\n    private eventFulfillsRoomMemberCountCondition(cond: IRoomMemberCountCondition, ev: MatrixEvent): boolean {\n        if (!cond.is) {\n            return false;\n        }\n\n        const room = this.client.getRoom(ev.getRoomId());\n        if (!room || !room.currentState || !room.currentState.members) {\n            return false;\n        }\n\n        const memberCount = room.currentState.getJoinedMemberCount();\n\n        const m = cond.is.match(/^([=<>]*)(\\d*)$/);\n        if (!m) {\n            return false;\n        }\n        const ineq = m[1];\n        const rhs = parseInt(m[2]);\n        if (isNaN(rhs)) {\n            return false;\n        }\n        switch (ineq) {\n            case \"\":\n            case \"==\":\n                return memberCount == rhs;\n            case \"<\":\n                return memberCount < rhs;\n            case \">\":\n                return memberCount > rhs;\n            case \"<=\":\n                return memberCount <= rhs;\n            case \">=\":\n                return memberCount >= rhs;\n            default:\n                return false;\n        }\n    }\n\n    private eventFulfillsDisplayNameCondition(cond: IContainsDisplayNameCondition, ev: MatrixEvent): boolean {\n        let content = ev.getContent();\n        if (ev.isEncrypted() && ev.getClearContent()) {\n            content = ev.getClearContent()!;\n        }\n        if (!content || !content.body || typeof content.body != \"string\") {\n            return false;\n        }\n\n        const room = this.client.getRoom(ev.getRoomId());\n        const member = room?.currentState?.getMember(this.client.credentials.userId!);\n        if (!member) {\n            return false;\n        }\n\n        const displayName = member.name;\n\n        // N.B. we can't use \\b as it chokes on unicode. however \\W seems to be okay\n        // as shorthand for [^0-9A-Za-z_].\n        const pat = new RegExp(\"(^|\\\\W)\" + escapeRegExp(displayName) + \"(\\\\W|$)\", \"i\");\n        return content.body.search(pat) > -1;\n    }\n\n    /**\n     * Check whether the given event matches the push rule condition by fetching\n     * the property from the event and comparing against the condition's glob-based\n     * pattern.\n     * @param cond - The push rule condition to check for a match.\n     * @param ev - The event to check for a match.\n     */\n    private eventFulfillsEventMatchCondition(cond: IEventMatchCondition, ev: MatrixEvent): boolean {\n        if (!cond.key) {\n            return false;\n        }\n\n        const val = this.valueForDottedKey(cond.key, ev);\n        if (typeof val !== \"string\") {\n            return false;\n        }\n\n        // XXX This does not match in a case-insensitive manner.\n        //\n        // See https://spec.matrix.org/v1.5/client-server-api/#conditions-1\n        if (cond.value) {\n            return cond.value === val;\n        }\n\n        if (typeof cond.pattern !== \"string\") {\n            return false;\n        }\n\n        const regex =\n            cond.key === \"content.body\"\n                ? this.createCachedRegex(\"(^|\\\\W)\", cond.pattern, \"(\\\\W|$)\")\n                : this.createCachedRegex(\"^\", cond.pattern, \"$\");\n\n        return !!val.match(regex);\n    }\n\n    /**\n     * Check whether the given event matches the push rule condition by fetching\n     * the property from the event and comparing exactly against the condition's\n     * value.\n     * @param cond - The push rule condition to check for a match.\n     * @param ev - The event to check for a match.\n     */\n    private eventFulfillsEventPropertyIsCondition(cond: IEventPropertyIsCondition, ev: MatrixEvent): boolean {\n        if (!cond.key || cond.value === undefined) {\n            return false;\n        }\n        return cond.value === this.valueForDottedKey(cond.key, ev);\n    }\n\n    /**\n     * Check whether the given event matches the push rule condition by fetching\n     * the property from the event and comparing exactly against the condition's\n     * value.\n     * @param cond - The push rule condition to check for a match.\n     * @param ev - The event to check for a match.\n     */\n    private eventFulfillsEventPropertyContains(cond: IEventPropertyContainsCondition, ev: MatrixEvent): boolean {\n        if (!cond.key || cond.value === undefined) {\n            return false;\n        }\n        const val = this.valueForDottedKey(cond.key, ev);\n        if (!Array.isArray(val)) {\n            return false;\n        }\n        return val.includes(cond.value);\n    }\n\n    private eventFulfillsCallStartedCondition(\n        _cond: ICallStartedCondition | ICallStartedPrefixCondition,\n        ev: MatrixEvent,\n    ): boolean {\n        // Since servers don't support properly sending push notification\n        // about MSC3401 call events, we do the handling ourselves\n        return (\n            [\"m.ring\", \"m.prompt\"].includes(ev.getContent()[\"m.intent\"]) &&\n            !(\"m.terminated\" in ev.getContent()) &&\n            (ev.getPrevContent()[\"m.terminated\"] !== ev.getContent()[\"m.terminated\"] ||\n                deepCompare(ev.getPrevContent(), {}))\n        );\n    }\n\n    private createCachedRegex(prefix: string, glob: string, suffix: string): RegExp {\n        if (PushProcessor.cachedGlobToRegex[glob]) {\n            return PushProcessor.cachedGlobToRegex[glob];\n        }\n        PushProcessor.cachedGlobToRegex[glob] = new RegExp(\n            prefix + globToRegexp(glob) + suffix,\n            \"i\", // Case insensitive\n        );\n        return PushProcessor.cachedGlobToRegex[glob];\n    }\n\n    /**\n     * Parse the key into the separate fields to search by splitting on\n     * unescaped \".\", and then removing any escape characters.\n     *\n     * @param str - The key of the push rule condition: a dotted field.\n     * @returns The unescaped parts to fetch.\n     * @internal\n     */\n    public static partsForDottedKey(str: string): string[] {\n        const result: string[] = [];\n\n        // The current field and whether the previous character was the escape\n        // character (a backslash).\n        let part = \"\";\n        let escaped = false;\n\n        // Iterate over each character, and decide whether to append to the current\n        // part (following the escape rules) or to start a new part (based on the\n        // field separator).\n        for (const c of str) {\n            // If the previous character was the escape character (a backslash)\n            // then decide what to append to the current part.\n            if (escaped) {\n                if (c === \"\\\\\" || c === \".\") {\n                    // An escaped backslash or dot just gets added.\n                    part += c;\n                } else {\n                    // A character that shouldn't be escaped gets the backslash prepended.\n                    part += \"\\\\\" + c;\n                }\n                // This always resets being escaped.\n                escaped = false;\n                continue;\n            }\n\n            if (c == \".\") {\n                // The field separator creates a new part.\n                result.push(part);\n                part = \"\";\n            } else if (c == \"\\\\\") {\n                // A backslash adds no characters, but starts an escape sequence.\n                escaped = true;\n            } else {\n                // Otherwise, just add the current character.\n                part += c;\n            }\n        }\n\n        // Ensure the final part is included. If there's an open escape sequence\n        // it should be included.\n        if (escaped) {\n            part += \"\\\\\";\n        }\n        result.push(part);\n\n        return result;\n    }\n\n    /**\n     * For a dotted field and event, fetch the value at that position, if one\n     * exists.\n     *\n     * @param key - The key of the push rule condition: a dotted field to fetch.\n     * @param ev - The matrix event to fetch the field from.\n     * @returns The value at the dotted path given by key.\n     */\n    private valueForDottedKey(key: string, ev: MatrixEvent): any {\n        // The key should already have been parsed via updateCachedPushRuleKeys,\n        // but if it hasn't (maybe via an old consumer of the SDK which hasn't\n        // been updated?) then lazily calculate it here.\n        let parts = this.parsedKeys.get(key);\n        if (parts === undefined) {\n            parts = PushProcessor.partsForDottedKey(key);\n            this.parsedKeys.set(key, parts);\n        }\n        let val: any;\n\n        // special-case the first component to deal with encrypted messages\n        const firstPart = parts[0];\n        let currentIndex = 0;\n        if (firstPart === \"content\") {\n            val = ev.getContent();\n            ++currentIndex;\n        } else if (firstPart === \"type\") {\n            val = ev.getType();\n            ++currentIndex;\n        } else {\n            // use the raw event for any other fields\n            val = ev.event;\n        }\n\n        for (; currentIndex < parts.length; ++currentIndex) {\n            // The previous iteration resulted in null or undefined, bail (and\n            // avoid the type error of attempting to retrieve a property).\n            if (isNullOrUndefined(val)) {\n                return undefined;\n            }\n\n            const thisPart = parts[currentIndex];\n            val = val[thisPart];\n        }\n        return val;\n    }\n\n    private matchingRuleForEventWithRulesets(ev: MatrixEvent, rulesets?: IPushRules): IAnnotatedPushRule | null {\n        if (!rulesets) {\n            return null;\n        }\n\n        if (ev.getSender() === this.client.getSafeUserId()) {\n            return null;\n        }\n\n        return this.matchingRuleFromKindSet(ev, rulesets.global);\n    }\n\n    private pushActionsForEventAndRulesets(\n        ev: MatrixEvent,\n        rulesets?: IPushRules,\n    ): {\n        actions?: IActionsObject;\n        rule?: IAnnotatedPushRule;\n    } {\n        const rule = this.matchingRuleForEventWithRulesets(ev, rulesets);\n        if (!rule) {\n            return {};\n        }\n\n        const actionObj = PushProcessor.actionListToActionsObject(rule.actions);\n\n        // Some actions are implicit in some situations: we add those here\n        if (actionObj.tweaks.highlight === undefined) {\n            // if it isn't specified, highlight if it's a content\n            // rule but otherwise not\n            actionObj.tweaks.highlight = rule.kind == PushRuleKind.ContentSpecific;\n        }\n\n        return { actions: actionObj, rule };\n    }\n\n    public ruleMatchesEvent(rule: Partial<IPushRule> & Pick<IPushRule, \"conditions\">, ev: MatrixEvent): boolean {\n        // Disable the deprecated mentions push rules if the new mentions property exists.\n        if (\n            this.client.supportsIntentionalMentions() &&\n            ev.getContent()[\"m.mentions\"] !== undefined &&\n            (rule.rule_id === RuleId.ContainsUserName ||\n                rule.rule_id === RuleId.ContainsDisplayName ||\n                rule.rule_id === RuleId.AtRoomNotification)\n        ) {\n            return false;\n        }\n\n        return !rule.conditions?.some((cond) => !this.eventFulfillsCondition(cond, ev));\n    }\n\n    /**\n     * Get the user's push actions for the given event\n     */\n    public actionsForEvent(ev: MatrixEvent): IActionsObject {\n        const { actions } = this.pushActionsForEventAndRulesets(ev, this.client.pushRules);\n        return actions || ({} as IActionsObject);\n    }\n\n    public actionsAndRuleForEvent(ev: MatrixEvent): {\n        actions?: IActionsObject;\n        rule?: IAnnotatedPushRule;\n    } {\n        return this.pushActionsForEventAndRulesets(ev, this.client.pushRules);\n    }\n\n    /**\n     * Get one of the users push rules by its ID\n     *\n     * @param ruleId - The ID of the rule to search for\n     * @returns The push rule, or null if no such rule was found\n     */\n    public getPushRuleById(ruleId: string): IPushRule | null {\n        const result = this.getPushRuleAndKindById(ruleId);\n        return result?.rule ?? null;\n    }\n\n    /**\n     * Get one of the users push rules by its ID\n     *\n     * @param ruleId - The ID of the rule to search for\n     * @returns rule The push rule, or null if no such rule was found\n     * @returns kind - The PushRuleKind of the rule to search for\n     */\n    public getPushRuleAndKindById(ruleId: string): { rule: IPushRule; kind: PushRuleKind } | null {\n        for (const scope of [\"global\"] as const) {\n            if (this.client.pushRules?.[scope] === undefined) continue;\n\n            for (const kind of RULEKINDS_IN_ORDER) {\n                if (this.client.pushRules[scope][kind] === undefined) continue;\n\n                for (const rule of this.client.pushRules[scope][kind]!) {\n                    if (rule.rule_id === ruleId) return { rule, kind };\n                }\n            }\n        }\n        return null;\n    }\n}\n"],"mappings":"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","ignoreList":[]}